---
title: "Testing Model Format"
author: "Lukas"
date: "2023-01-30"
output: html_document
---

Packages
```{r}
library(lme4)
library(VGAM)
library(car)
library(tseries)
```


Load MATLAB Data
```{r}
#Aug_05 <- read.csv("C:\\Users\\buhl5\\Desktop\\Plan B Files\\Aug_05_table.csv")
Aug_08 <- read.csv("C:\\Users\\buhl5\\Desktop\\Plan B Files\\PMA17\\Aug_08_table.csv")
Aug_09 <- read.csv("C:\\Users\\buhl5\\Desktop\\Plan B Files\\PMA17\\Aug_09_table.csv")
Aug_12 <- read.csv("C:\\Users\\buhl5\\Desktop\\Plan B Files\\PMA17\\Aug_12_table.csv")
Aug_15 <- read.csv("C:\\Users\\buhl5\\Desktop\\Plan B Files\\PMA17\\Aug_15_table.csv")
Oct_12 <- read.csv("C:\\Users\\buhl5\\Desktop\\Plan B Files\\PMA17\\Oct_12_table.csv")
```

Adjust Days because I forgot to in MATLAB

```{r}
Aug_08$Day <- 2
Aug_09$Day <- 3
Aug_12$Day <- 4
Aug_15$Day <- 5
Oct_12$Day <- 6
```

Day will likely be more useful when the days are all ran together with no gaps

Full Ephys Dataset
```{r}
Data <- rbind(Aug_08,Aug_09,Aug_12,Aug_15,Oct_12)# rbind(Aug_05,Aug_08,Aug_09,Aug_12,Aug_15,Oct_12)
rm(Aug_08,Aug_09,Aug_12,Aug_15,Oct_12)# rm(Aug_05,Aug_08,Aug_09,Aug_12,Aug_15,Oct_12)
```


Factors
```{r}
Data$Day <- as.factor(Data$Day)
Data$Tone <- as.factor(Data$Tone)
Data$Bin <- as.factor(Data$Bin)
```


Load Behavior Data
```{r}
## I Need to run August 5th through Analysis
#Aug_05_Behav <- read.csv("C:\Users\buhl5\Downloads\08_05_new_R_TB_PMA17.csv")
Aug_08_Behav <- read.csv("C:\\Users\\buhl5\\Downloads\\08_08_new_R_TB_PMA17.csv")
Aug_09_Behav <- read.csv("C:\\Users\\buhl5\\Downloads\\08_09_new_R_TB_PMA17.csv")
Aug_12_Behav <- read.csv("C:\\Users\\buhl5\\Downloads\\08_12_new_R_TB_PMA17.csv")
Aug_15_Behav <- read.csv("C:\\Users\\buhl5\\Downloads\\08_15_new_R_TB_PMA17.csv")
Oct_12_Behav <- read.csv("C:\\Users\\buhl5\\Downloads\\10_12_new_R_TB_PMA17.csv")
```

Pull Time Specific Bins currently time 0 to 29. Will likely be adjusted to only tones

```{r}
Aug_08_Behav_p  <-  Aug_08_Behav[Aug_08_Behav[,2] %in% c(0:29),3]
Aug_09_Behav_p  <-  Aug_09_Behav[Aug_09_Behav[,2] %in% c(0:29),3]
Aug_12_Behav_p  <-  Aug_12_Behav[Aug_12_Behav[,2] %in% c(0:29),3]
Aug_15_Behav_p  <-  Aug_15_Behav[Aug_15_Behav[,2] %in% c(0:29),3]
Oct_12_Behav_p  <-  Oct_12_Behav[Oct_12_Behav[,2] %in% c(0:29),3]
```

All Behave

```{r}
#Behave <- rbind(Aug_05_Behav_p,Aug_08_Behav_p,Aug_09_Behav_p,Aug_12_Behav_p,Aug_15_Behav_p,Oct_12_Behav_p)
Behave <- c(Aug_08_Behav_p,Aug_09_Behav_p,Aug_12_Behav_p,Aug_15_Behav_p,Oct_12_Behav_p)

Data$Platform <- Behave
```


Clean
```{r}
#rm(Aug_05_Behav_p,Aug_08_Behav_p,Aug_09_Behav_p,Aug_12_Behav_p,Aug_15_Behav_p,Oct_12_Behav_p,Behave)
#rm(Aug_05_Behav,Aug_08_Behav,Aug_09_Behav,Aug_12_Behav,Aug_15_Behav,Oct_12_Behav)
rm(Aug_08_Behav,Aug_09_Behav,Aug_12_Behav,Aug_15_Behav,Oct_12_Behav)
rm(Aug_08_Behav_p,Aug_09_Behav_p,Aug_12_Behav_p,Aug_15_Behav_p,Oct_12_Behav_p,Behave)
```

Data needs to be adjusted to accommodate 0 and 1

```{r}
#Playing it safe using a loop

offset <- 0.00001


for(i in 1:length(Data$Platform)){
  
  if(Data$Platform[i] == 0){Data$Platform[i] <- offset}
  if(Data$Platform[i] == 1){Data$Platform[i] <- 1 - offset}
}
```

Is it autoregressive or moving average?

```{r}
plot(ts(Data$Platform))
```


```{r}
acf(ts(Data$Platform),main="Autocorrelation of Platform Time")
```

```{r}
pacf(ts(Data$Platform),main="Autocorrelation of Platform Time")
```

ADF test
```{r}
adf.test(Data$Platform, alternative="stationary", k=0)
```

Lagged Differences
```{r}
acf(diff(Data$Platform),main="Autocorrelation of Lagged Differences of Platform Time")
```

Base Arima Model

```{r}
small.data <- Data[,c(1:6,187)]
modmat <-  model.matrix(Platform~.,Data)
```


```{r}
(fit_small <- arima(probitlink(Data$Platform), c(1, 1, 1),seasonal = list(order = c(0, 1, 1), period = 30), xreg = modmat[,-1],optim.method = "BFGS"))
```


```{r}
Datats <- ts(probitlink(Data$Platform))
```


May need less variables so that the fit converges.
```{r}
(coh_theta_band <- arima(Datats, c(1, 0, 1),seasonal = list(order = c(0, 1, 1), period = 30), xreg = Data[,c(14:18,44:48,74:78)],optim.method = "BFGS"))
```


```{r}
#Need inputs for forecasted data to get predict output
#pred <- predict(coh_theta_band, n.ahead = 30, newxreg=)
#ts.plot(Data$Platform,pred$pred, log = "y", lty = c(1,3))
```


%%% IGNORE BELOW THIS LINE %%%


First Test glm reservse lme4 for multiple rats or if different variable is deemed to need a randome effect

```{r}
mod.1 <- lm( probitlink(Platform)~., data = Data)
sum.1 <- summary(mod.1)
names(sum.1)
```
```{r}
sum.1$sigma
sum.1$df
sum.1$r.squared
```


```{r}
significantbywald <- row.names(sum.1$coefficients[sum.1$coefficients[,4] < 0.05,])
significantbywald
```

Anova Test
```{r}
anova.1 <- Anova(mod.1,type = "II")
significantbyanova <- row.names(anova.1[anova.1[,4] < 0.05,])
significantbyanova
```

Intersection
```{r}
both.1 <- intersect(significantbywald,significantbywald)
```

Counts of each region
```{r}
paste0("Total IL Power")
sum(grepl('IL_pow',both.1))

paste0("Total PL Power")
sum(grepl('PL_pow',both.1))

paste0("Total BLA Power")
sum(grepl('BLA_pow',both.1))

paste0("Total ILPL")
sum(grepl('ILPL',both.1))

paste0("Total ILBLA")
sum(grepl('ILBLA',both.1))

paste0("Total PLBLA")
sum(grepl('PLBLA',both.1))
```





